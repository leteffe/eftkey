<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>eftkey - Pairing</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 2rem; display: grid; place-items: start center; gap: 2rem; }
      .card { width: min(560px, 92vw); border: 1px solid #dadada33; border-radius: 12px; padding: 1.25rem 1.5rem; box-shadow: 0 1px 2px rgba(0,0,0,.05); background: rgba(255,255,255,.04); }
      h1 { margin: 0 0 1rem; font-size: 1.25rem; }
      label { display: block; font-size: .9rem; opacity: .8; margin-bottom: .25rem; }
      input[type="text"] { width: 100%; padding: .75rem .9rem; border: 1px solid #ccc; border-radius: 10px; font-size: 1rem; }
      .row { display: flex; gap: .75rem; align-items: center; }
      button { appearance: none; border: 0; background: #0d6efd; color: white; padding: .7rem 1rem; border-radius: 10px; font-weight: 600; cursor: pointer; }
      button:disabled { opacity: .6; cursor: not-allowed; }
      .muted { opacity: .75; font-size: .9rem; }
      .ok { color: #198754; font-weight: 600; }
      .err { color: #dc3545; font-weight: 600; }
      pre { white-space: pre-wrap; word-break: break-word; background: rgba(0,0,0,.04); padding: .75rem; border-radius: 8px; }
      .logbox { height: 240px; overflow: auto; background: rgba(0,0,0,.04); padding: .75rem; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Mit PayTec-Terminal pairen</h1>
      <div class="row" style="margin-bottom:.5rem">
        <label for="termId">Terminal-ID</label>
        <input id="termId" type="text" placeholder="terminalA" style="width:160px" />
        <button id="btnLoadPairing" type="button">Laden</button>
      </div>
      <form id="pairForm">
        <label for="code">Pairing-Code vom Terminal</label>
        <div class="row">
          <input id="code" name="code" type="text" placeholder="6017087" required pattern="^[A-Za-z0-9]{5,}$" />
          <button id="pairBtn" type="submit">Pairen</button>
        </div>
      </form>
      <p id="msg" class="muted">Geben Sie den vom Terminal angezeigten Code ein (z. B. 6017087).</p>
    </div>

    <div class="card">
      <h1>Status</h1>
      <div id="status">Lade...</div>
      <div class="muted" id="conn">Verbindung: unbekannt</div>
      <div class="row" style="margin-top:.75rem">
        <button id="btnActivate">Terminal aktivieren</button>
        <button id="btnDiag">Diagnose</button>
      </div>
      <pre id="pairingJson" style="display:none"></pre>
    </div>

    <div class="card">
      <h1>Transaktionen</h1>
      <div class="row" style="flex-wrap: wrap; gap: .5rem 1rem;">
        <button id="btnAccountVer">ACCOUNT_VERIFICATION</button>
      </div>
      <div style="margin-top: 1rem; display: grid; gap: .5rem;">
        <label for="amt">PURCHASE Betrag (Minor Units, z. B. 1575 = 15.75)</label>
        <div class="row">
          <input id="amt" type="number" min="1" step="1" placeholder="1575" />
          <button id="btnPurchase">PURCHASE starten</button>
        </div>
      </div>
      <p id="trxMsg" class="muted">Starte eine Transaktion auf dem Terminal.</p>
      <div style="margin-top: 1rem; display: grid; gap: .5rem;">
        <label>Loop-Modus: ACCOUNT_VERIFICATION nach Beleg automatisch erneut starten</label>
        <div class="row">
          <input id="loopEnabled" type="checkbox" />
          <label for="loopDelay" style="margin-left:.5rem">Verzögerung (ms)</label>
          <input id="loopDelay" type="number" min="0" step="100" value="2000" style="width:120px" />
          <button id="btnSaveLoop">Speichern</button>
        </div>
      </div>
      <div style="margin-top: 1rem; display: grid; gap: .5rem;">
        <label>Loop PURCHASE: Betrag (Minor Units), Währungscode (default 756), Verzögerung</label>
        <div class="row">
          <input id="loopPAmt" type="number" min="1" step="1" placeholder="1575" style="width:120px" />
          <input id="loopPCurr" type="number" min="1" step="1" value="756" style="width:100px" />
          <input id="loopPDelay" type="number" min="0" step="100" value="2000" style="width:120px" />
          <input id="loopPEnabled" type="checkbox" />
          <button id="btnSavePLoop">Speichern (Purchase Loop)</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h1>Logs</h1>
      <div class="row" style="margin-bottom:.5rem">
        <button id="btnClearLog" type="button">Logs leeren</button>
      </div>
      <div id="log" class="logbox"></div>
    </div>

    <script>
      function ts() {
        const d = new Date();
        return (
          d.getFullYear().toString().padStart(4, '0') + '-' +
          (d.getMonth()+1).toString().padStart(2,'0') + '-' +
          d.getDate().toString().padStart(2,'0') + ' ' +
          d.getHours().toString().padStart(2,'0') + ':' +
          d.getMinutes().toString().padStart(2,'0') + ':' +
          d.getSeconds().toString().padStart(2,'0') + '.' +
          d.getMilliseconds().toString().padStart(3,'0')
        );
      }

      function log(msg, data) {
        const el = document.getElementById('log');
        const line = document.createElement('div');
        const text = (typeof msg === 'string' ? msg : JSON.stringify(msg));
        line.textContent = `[${ts()}] ${text}` + (data ? `\n${typeof data === 'string' ? data : JSON.stringify(data)}` : '');
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
      }

      async function fetchStatus() {
        try {
          const id = (document.getElementById('termId').value || '').trim();
          const url = id ? `/pairing/${encodeURIComponent(id)}` : '/pairing';
          const res = await fetch(url);
          const data = await res.json();
          log(`GET ${url}`, data);
          const status = document.getElementById('status');
          const pre = document.getElementById('pairingJson');
          if (data && data.Channel) {
            status.innerHTML = '<span class="ok">Gepairt</span>';
            pre.style.display = 'block';
            pre.textContent = JSON.stringify(data, null, 2);
          } else {
            status.innerHTML = 'Nicht gepairt';
            pre.style.display = 'none';
            pre.textContent = '';
          }
        } catch (e) {
          log('GET /pairing failed', String(e));
          document.getElementById('status').innerHTML = '<span class="err">Fehler beim Laden</span>';
        }
      }

      document.getElementById('btnLoadPairing').addEventListener('click', fetchStatus);

      document.getElementById('pairForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('code').value.trim();
        const id = (document.getElementById('termId').value || '').trim();
        const btn = document.getElementById('pairBtn');
        const msg = document.getElementById('msg');
        btn.disabled = true;
        msg.textContent = 'Sende Code...';
        try {
          const url = id ? `/pair/${encodeURIComponent(id)}` : '/pair';
          const res = await fetch(url, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code })
          });
          log(`POST ${url}`, { code });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          msg.textContent = 'Code gesendet. Bitte bestätigen Sie am Terminal.';
          setTimeout(fetchStatus, 2000);
        } catch (err) {
          log('POST /pair failed', String(err));
          msg.innerHTML = '<span class="err">Fehler beim Pairing</span>';
        } finally {
          btn.disabled = false;
        }
      });

      fetchStatus();
      setInterval(fetchStatus, 5000);
      // Init loop state from server (single-AV)
      (async function initLoop(){
        try {
          const r = await fetch('/loop');
          const j = await r.json();
          document.getElementById('loopEnabled').checked = !!j.enabled;
          document.getElementById('loopDelay').value = String(j.delayMs ?? 2000);
        } catch {}
      })();
      // Init purchase loop per id
      async function initPurchaseLoop() {
        const id = (document.getElementById('termId').value || '').trim();
        if (!id) return;
        try {
          const r = await fetch(`/loop/${encodeURIComponent(id)}/purchase`);
          const j = await r.json();
          document.getElementById('loopPEnabled').checked = !!j.enabled;
          if (j.amount) document.getElementById('loopPAmt').value = String(j.amount);
          document.getElementById('loopPCurr').value = String(j.TrxCurrC ?? 756);
          document.getElementById('loopPDelay').value = String(j.delayMs ?? 2000);
        } catch {}
      }
      // Subscribe to SSE logs
      try {
        let es = new EventSource('/logs');
        const el = document.getElementById('log');
        const known = [
          'connected','disconnected','pairingSucceeded','pairingFailed','status',
          'messageSent','messageReceived','error','activationSucceeded','activationFailed',
          'transactionApproved','transactionDeclined','transactionAborted','transactionTimedOut',
          'transactionConfirmationSucceeded','transactionConfirmationFailed'
        ];
        for (const evt of known) {
          es.addEventListener(evt, (ev) => {
            let data = null;
            try { data = ev.data ? JSON.parse(ev.data) : null; } catch { data = String(ev.data); }
            log(`evt:${evt}`, data);
            if (evt === 'connected') {
              document.getElementById('conn').innerHTML = '<span class="ok">Verbindung: verbunden</span>';
            }
            if (evt === 'disconnected') {
              document.getElementById('conn').innerHTML = '<span class="err">Verbindung: getrennt</span>';
            }
          });
        }
        es.onerror = (e) => log('sse_error');
        es.onopen = () => log('sse_open');

        // Rebind SSE to per-id when terminal id changes/loaded
        document.getElementById('btnLoadPairing').addEventListener('click', () => {
          const id = (document.getElementById('termId').value || '').trim();
          try { es.close(); } catch {}
          es = new EventSource(id ? `/logs/${encodeURIComponent(id)}` : '/logs');
          initPurchaseLoop();
          for (const evt of known) {
            es.addEventListener(evt, (ev) => {
              let data = null;
              try { data = ev.data ? JSON.parse(ev.data) : null; } catch { data = String(ev.data); }
              log(`evt:${evt}`, data);
              if (evt === 'connected') document.getElementById('conn').innerHTML = '<span class="ok">Verbindung: verbunden</span>';
              if (evt === 'disconnected') document.getElementById('conn').innerHTML = '<span class="err">Verbindung: getrennt</span>';
            });
          }
        });
      } catch (e) {
        log('sse_init_failed', String(e));
      }

      document.getElementById('btnActivate').addEventListener('click', async () => {
        const msg = document.getElementById('trxMsg');
        try {
          const id = (document.getElementById('termId').value || '').trim();
          const url = id ? `/activate/${encodeURIComponent(id)}` : '/activate';
          const res = await fetch(url, { method: 'POST' });
          log(`POST ${url}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          msg.textContent = 'Activation angefordert. Bitte Terminal beachten.';
        } catch (e) {
          log('POST /activate failed', String(e));
          msg.innerHTML = '<span class=err>Fehler bei Activation</span>';
        }
      });

      // Verbindung testen: ruft /diagnostics und /diagnostics/terminal/:id auf
      document.getElementById('btnDiag').addEventListener('click', async () => {
        try {
          const globalRes = await fetch('/diagnostics');
          const globalJson = await globalRes.json();
          log('GET /diagnostics', globalJson);
        } catch (e) {
          log('GET /diagnostics failed', String(e));
        }
        try {
          const id = (document.getElementById('termId').value || '').trim();
          if (id) {
            const tRes = await fetch(`/diagnostics/terminal/${encodeURIComponent(id)}`);
            const tJson = await tRes.json();
            log(`GET /diagnostics/terminal/${id}`, tJson);
            if (tJson && tJson.ready === true) {
              document.getElementById('conn').innerHTML = '<span class="ok">Verbindung: bereit</span>';
            }
          }
        } catch (e) {
          log('GET /diagnostics/terminal failed', String(e));
        }
      });

      document.getElementById('btnAccountVer').addEventListener('click', async () => {
        const msg = document.getElementById('trxMsg');
        msg.textContent = 'Starte ACCOUNT_VERIFICATION...';
        try {
          const id = (document.getElementById('termId').value || '').trim();
          const url = id ? `/transaction/${encodeURIComponent(id)}/account-verification` : '/transaction/account-verification';
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ RecOrderRef: { OrderID: 'OrderAV-1' } }) });
          log(`POST ${url}`);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          msg.textContent = 'ACCOUNT_VERIFICATION gestartet. Bitte Terminal beachten.';
        } catch (e) {
          log('POST /transaction/account-verification failed', String(e));
          msg.innerHTML = '<span class=err>Fehler beim Starten</span>';
        }
      });

      document.getElementById('btnPurchase').addEventListener('click', async () => {
        const msg = document.getElementById('trxMsg');
        const amt = parseInt(String((document.getElementById('amt')).value || '0'), 10);
        if (!amt || amt <= 0) { msg.innerHTML = '<span class=err>Betrag (Minor Units) erforderlich</span>'; return; }
        msg.textContent = 'Starte PURCHASE...';
        try {
          const id = (document.getElementById('termId').value || '').trim();
          const url = id ? `/transaction/${encodeURIComponent(id)}/purchase` : '/transaction/purchase';
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ AmtAuth: amt, TrxCurrC: 756, RecOrderRef: { OrderID: 'OrderP-1' } }) });
          log(`POST ${url}`, { AmtAuth: amt, TrxCurrC: 756 });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          msg.textContent = 'PURCHASE gestartet. Bitte Terminal beachten.';
        } catch (e) {
          log('POST /transaction/purchase failed', String(e));
          msg.innerHTML = '<span class=err>Fehler beim Starten</span>';
        }
      });

      document.getElementById('btnSaveLoop').addEventListener('click', async () => {
        const id = (document.getElementById('termId').value || '').trim();
        if (!id) { log('loop requires Terminal-ID'); return; }
        const enabled = document.getElementById('loopEnabled').checked;
        const delayMs = parseInt(document.getElementById('loopDelay').value || '0', 10) || 0;
        const url = `/loop/${encodeURIComponent(id)}`;
        log(`POST ${url}`, { enabled, delayMs });
        try {
          const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled, delayMs }) });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          log('Loop updated');
        } catch (e) {
          log('POST /loop failed', String(e));
        }
      });

      document.getElementById('btnSavePLoop').addEventListener('click', async () => {
        const id = (document.getElementById('termId').value || '').trim();
        if (!id) { log('purchase loop requires Terminal-ID'); return; }
        const enabled = document.getElementById('loopPEnabled').checked;
        const amount = parseInt(document.getElementById('loopPAmt').value || '0', 10) || 0;
        const TrxCurrC = parseInt(document.getElementById('loopPCurr').value || '756', 10) || 756;
        const delayMs = parseInt(document.getElementById('loopPDelay').value || '0', 10) || 0;
        const url = `/loop/${encodeURIComponent(id)}/purchase`;
        log(`POST ${url}`, { enabled, amount, TrxCurrC, delayMs });
        try {
          const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled, amount, TrxCurrC, delayMs }) });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          log('Purchase loop updated');
        } catch (e) {
          log('purchase loop update failed', String(e));
        }
      });

      document.getElementById('btnClearLog').addEventListener('click', () => {
        const el = document.getElementById('log');
        el.textContent = '';
      });
    </script>
  </body>
</html>
